// Generated by CoffeeScript 1.6.1
(function() {
  var Layout,
    _this = this;

  Layout = (function() {

    function Layout(width, height, selector) {
      var _this = this;
      this.width = width;
      this.height = height;
      this.selector = selector;
      this._redraw = function() {
        return Layout.prototype._redraw.apply(_this, arguments);
      };
      this._joinNodes = function(parent, child) {
        return Layout.prototype._joinNodes.apply(_this, arguments);
      };
      this._addInitialParticles = function() {
        return Layout.prototype._addInitialParticles.apply(_this, arguments);
      };
      this._newParticleFrom = function(node, parent) {
        return Layout.prototype._newParticleFrom.apply(_this, arguments);
      };
      this._setup = function() {
        return Layout.prototype._setup.apply(_this, arguments);
      };
      this.start = function() {
        return Layout.prototype.start.apply(_this, arguments);
      };
      this.grow = function() {
        return Layout.prototype.grow.apply(_this, arguments);
      };
      this.roots = [new Blue(), new Red(), new Blue(), new Blue(), new Red(), new Red()];
      this.outerLayer = this.roots;
      this.growthIter = 1;
    }

    Layout.prototype.grow = function() {
      var child, firstChild, growth, lastChild, parent, _i, _j, _len, _len1, _ref, _ref1;
      console.log("Grow!");
      this.growthIter += 1;
      this.collision = new Collision();
      growth = [];
      firstChild = null;
      lastChild = null;
      _ref = this.outerLayer;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        parent = _ref[_i];
        _ref1 = parent.grow();
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          child = _ref1[_j];
          this._newParticleFrom(child, parent);
          this._joinNodes(parent, child);
          if (firstChild == null) {
            firstChild = child;
          }
          if (lastChild != null) {
            this._joinNodes(lastChild, child);
          }
          growth.push(child);
          lastChild = child;
        }
      }
      this._joinNodes(lastChild, firstChild);
      return this.outerLayer = growth;
    };

    Layout.prototype.start = function() {
      this._setup();
      return this._redraw();
    };

    Layout.prototype._setup = function() {
      var center, container, gap, max, min;
      this.physics = new Physics();
      this.height = window.innerHeight;
      this.width = window.innerWidth;
      this.stiffness = 0.1;
      this.spacing = 50.0;
      this.physics.integrator = new Verlet();
      this.physics.viscosity = 0.9;
      gap = 50.0;
      min = new Vector(-gap, -gap);
      max = new Vector(this.width + gap, this.height + gap);
      this.edge = new EdgeBounce(min, max);
      this.wander = new Wander(0.05, 100.0, 80.0);
      this.collision = new Collision();
      center = new Vector(this.width * 0.5, this.height * 0.5);
      console.dir(center);
      this.renderer = new CanvasRenderer();
      container = $(this.selector);
      container.get(0).appendChild(this.renderer.domElement);
      this.renderer.renderMouse = false;
      this.renderer.init(this.physics);
      this.renderer.setSize(this.width, this.height);
      return this._addInitialParticles();
    };

    Layout.prototype._newParticleFrom = function(node, parent) {
      var center, p, repulsion, xPerturb, yPerturb;
      center = new Vector(this.width * Math.random(), this.height * Math.random());
      if (parent != null) {
        xPerturb = -0.5 + Math.random();
        yPerturb = -0.5 + Math.random();
        center = new Vector(parent.particle.pos.x + xPerturb, parent.particle.pos.y + yPerturb);
      }
      if (parent != null) {
        parent.particle.colour = "FFFFFF";
      }
      p = new Particle(6.0);
      p.colour = node.color;
      p.moveTo(center);
      p.setRadius(10.0);
      repulsion = new Attraction(p.pos, 20, -2000);
      p.behaviours.push(this.edge);
      if (this.prevCollision != null) {
        p.behaviours.push(this.prevCollision);
        this.prevCollision.pool.push(p);
      }
      p.behaviours.push(this.collision);
      this.collision.pool.push(p);
      p.behaviours.push(repulsion);
      this.physics.particles.push(p);
      return node.particle = p;
    };

    Layout.prototype._addInitialParticles = function() {
      var i, initial, _i, _j, _len, _ref, _ref1;
      _ref = this.outerLayer;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        initial = _ref[_i];
        this._newParticleFrom(initial);
      }
      if (this.outerLayer.length > 1) {
        for (i = _j = 0, _ref1 = this.outerLayer.length - 1; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; i = 0 <= _ref1 ? ++_j : --_j) {
          this._joinNodes(this.outerLayer[i], this.outerLayer[i + 1]);
        }
        return this._joinNodes(this.outerLayer[this.outerLayer.length - 1], this.outerLayer[0]);
      }
    };

    Layout.prototype._joinNodes = function(parent, child) {
      var spring;
      spring = new Spring(parent.particle, child.particle, this.spacing, this.stiffness);
      return this.physics.springs.push(spring);
    };

    Layout.prototype._redraw = function() {
      requestAnimationFrame(this._redraw);
      this.physics.step();
      return this.renderer.render(this.physics);
    };

    return Layout;

  })();

  window.Layout = Layout;

}).call(this);
